import os
from dotenv import load_dotenv
import openai
import telebot
from datetime import datetime
import sys

# Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð° .env
load_dotenv()

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

if not TELEGRAM_TOKEN:
    raise ValueError("TELEGRAM_TOKEN Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°")

if not OPENAI_API_KEY:
    raise ValueError("OPENAI_API_KEY Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°")

bot = telebot.TeleBot(TELEGRAM_TOKEN)
openai.api_key = OPENAI_API_KEY

# Ð¡Ð»Ð¾Ð²Ð°Ñ€ÑŒ Ñ Ð´Ð½ÑÐ¼Ð¸ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ
birthdays = {
    "Ð‘Ð¾Ð·Ð¾Ñ€Ð¾Ð²Ð° Ð¤": "27 Ð´ÐµÐºÐ°Ð±Ñ€Ñ",
    "ÐšÑƒÑ€Ð±Ð¾Ð½Ð¾Ð²Ð° Ðœ": "15 Ð¼Ð°Ñ€Ñ‚",
    "ÐÐ·Ð¸Ð¼Ð¾Ð²Ð° Ð›": "31 Ð°Ð²Ð³ÑƒÑÑ‚",
    "ÐÑƒÑ€Ð¼Ð°Ð¼Ð°Ñ‚Ð¾Ð²Ð° Ð›": "30 Ð°Ð¿Ñ€ÐµÐ»ÑŒ",
    "Ð¢ÐµÐ¼Ð¸Ñ€Ð¾Ð²Ð°": "29 Ð°Ð¿Ñ€ÐµÐ»ÑŒ",
    "Ð£Ð¼Ð°Ñ€Ð¾Ð² Ð–": "31 Ð¼Ð°Ñ€Ñ‚",
    "Ð Ð°Ñ…Ð¼Ð¾Ð½Ð¾Ð² Ð¤": "6 Ð¼Ð°Ñ€Ñ‚",
    "ÐÐ°Ñ„Ð¸ÑÐ°": "12 Ð½Ð¾ÑÐ±Ñ€ÑŒ",
    "ÐšÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð° x": "5 Ð´ÐµÐºÐ°Ð±Ñ€ÑŒ",
    "Ð–ÑƒÐ¼Ð°ÐµÐ²Ð° Ð”Ð¸Ð»Ð¸Ñ‡ÐºÐ°": "1 Ð½Ð¾ÑÐ±Ñ€ÑŒ",
    "ÐœÐ¾Ñ‡Ð¸Ñ‡ÐµÑ…Ñ€Ð°": "23 Ð¸ÑŽÐ½ÑŒ",
    "Ð“ÑƒÐ»Ð¸Ñ‡ÐºÐ°": "19 Ð¼Ð°Ð¹",
    "ÐœÑƒÑ€Ð¾Ð´": "31 Ð°Ð²Ð³ÑƒÑÑ‚",
    "ÐÐ±Ð´ÑƒÐ»Ð»Ð°ÐµÐ²": "30 Ð°Ð²Ð³ÑƒÑÑ‚",
    "Ð¡Ð°Ð½Ð¶Ð°Ñ€": "8 Ñ„ÐµÐ²Ñ€Ð°Ð»ÑŒ",
    "Ð­Ð»Ð±ÐµÐº": "22 Ð°Ð²Ð³ÑƒÑÑ‚",
    "ÐÐ¼Ð¸Ð½Ð¾Ð²": "10 Ð°Ð²Ð³ÑƒÑÑ‚",
    "Ð˜ÑÑ€Ð¾Ð¸Ð»": "14 ÑÐ½Ð²Ð°Ñ€ÑŒ",
    "ÐÐ°Ð²Ð±Ð°Ñ…Ð¾Ñ€": "29 Ð¼Ð°Ñ€Ñ‚",
    "Ð‘Ð¾Ð±Ð¸Ñ€": "28 Ñ„ÐµÐ²Ñ€Ð°Ð»ÑŒ",
    "Ð¡Ð¸Ñ€Ð¾Ð¶": "12 Ð°Ð²Ð³ÑƒÑÑ‚",
    "Ð“ÑƒÐ»Ð±Ð°Ñ…Ð¾Ñ€": "23 Ð°Ð¿Ñ€ÐµÐ»ÑŒ",
    "Ð­Ð»Ñ‘Ñ€": "10 Ð´ÐµÐºÐ°Ð±Ñ€ÑŒ",
    "ÐœÐ¾Ñ…Ð¸Ð³ÑƒÐ»": "25 Ð¼Ð°Ñ€Ñ‚"
}

# Ð¢ÐµÐºÑÑ‚ Ð¿Ð¾Ð·Ð´Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
BIRTHDAY_MESSAGE = (
    "ÐÑÑÐ°Ð»Ð¾Ð¼Ñƒ Ð°Ð»Ð°Ð¹ÐºÑƒÐ¼! ðŸŒŸ\n\n"
    "Ð‘ÑƒÐ³ÑƒÐ½ ÑÐ¸Ð· ÑƒÑ‡ÑƒÐ½ Ð¼Ð°Ñ…ÑÑƒÑ ÐºÑƒÐ½ â€“ Ñ‚ÑƒÒ“Ð¸Ð»Ð³Ð°Ð½ ÐºÑƒÐ½Ð¸Ð½Ð³Ð¸Ð· Ð¼ÑƒÐ±Ð¾Ñ€Ð°Ðº Ð±ÑžÐ»ÑÐ¸Ð½! ðŸŽ‰ Ð¨ÑƒÐ½Ð´Ð°Ð¹ ÑƒÐ»ÑƒÒ“ ÐºÑƒÐ½Ð»Ð°Ñ€Ð´Ð° ÑÐ¸Ð·Ð³Ð° Ð±Ð°Ñ€Ñ‡Ð° ÑÐ·Ð³ÑƒÐ»Ð¸ÐºÐ»Ð°Ñ€, "
    "ÑÐ¾Ò“Ð»Ð¸Ò›-ÑÐ°Ð»Ð¾Ð¼Ð°Ñ‚Ð»Ð¸Ðº, Ñ‚Ð¸Ð½Ñ‡Ð»Ð¸Ðº-Ñ„Ð°Ñ€Ð¾Ð²Ð¾Ð½Ð»Ð¸Ðº Ð²Ð° Ð°Ð»Ð±Ð°Ñ‚Ñ‚Ð°, Ð±Ð°Ñ…Ñ‚Ñƒ ÑÐ°Ð¾Ð´Ð°Ñ‚ Ñ‘Ñ€ Ð±ÑžÐ»ÑÐ¸Ð½!\n\n"
    "Ð¡Ð¸Ð·Ð½Ð¸Ð½Ð³ Ò³Ð°Ñ‘Ñ‚Ð¸Ð½Ð³Ð¸Ð·Ð³Ð° Ð¼ÑžÑŠÐ¶Ð¸Ð·Ð°Ð»Ð°Ñ€ Ð±Ð¸Ð»Ð°Ð½ Ñ‚ÑžÐ»ÑÐ¸Ð½, Ò³Ð°Ñ€ Ð±Ð¸Ñ€ ÐºÑƒÐ½Ð³Ð¸Ð·Ð½Ð¸ ÑÐ½Ð°Ð´Ð° Ñ‘Ñ€Ò›Ð¸Ð½ Ð²Ð° Ñ„Ð°Ð¹Ð·Ð»Ð¸ ÑžÑ‚ÐºÐ°Ð·Ð¸ÑˆÐ¸Ð½Ð³Ð¸Ð·Ð³Ð° Ñ‚Ð¸Ð»Ð°ÐºÐ´Ð¾ÑˆÐ¼Ð¸Ð·. "
    "Ð”ÑžÑÑ‚Ð»Ð°Ñ€Ð¸Ð½Ð³Ð¸Ð· Ð²Ð° ÑÒ›Ð¸Ð½Ð»Ð°Ñ€Ð¸Ð½Ð³Ð¸Ð· ÑÐ¸Ð· Ð±Ð¸Ð»Ð°Ð½ Ñ„Ð°Ñ…Ñ€Ð»Ð°Ð½ÑÐ¸Ð½Ð»Ð°Ñ€.\n\n"
    "Ð¯Ð½Ð³Ð¸ Ñ‘ÑˆÐ¸Ð½Ð³Ð¸Ð·Ð´Ð° Ð±Ð°Ñ€Ñ‡Ð° Ð¾Ñ€Ð·Ñƒ-Ð½Ð¸ÑÑ‚Ð»Ð°Ñ€Ð¸Ð½Ð³Ð¸Ð· Ñ€ÑžÑ‘Ð±Ð³Ð° Ñ‡Ð¸Ò›ÑÐ¸Ð½ Ð²Ð° ÑÐ¸Ð·Ð³Ð° Ð±ÐµÑ€Ð¸Ð»Ð°Ð´Ð¸Ð³Ð°Ð½ Ð¸Ð¼ÐºÐ¾Ð½Ð¸ÑÑ‚Ð»Ð°Ñ€ Ñ‡ÐµÐºÑÐ¸Ð· Ð±ÑžÐ»ÑÐ¸Ð½!\n\n"
    "Ð¡Ð¸Ð·Ð³Ð° Ñ‡Ð¸Ð½ Ð´Ð¸Ð»Ð´Ð°Ð½ Ð±Ð°Ñ…Ñ‚, Ð¾Ð¼Ð°Ð´, Ñ€Ð¸Ð²Ð¾Ð¶Ð»Ð°Ð½Ð¸Ñˆ Ð²Ð° ÑÐ½Ð³ Ð¼ÑƒÒ³Ð¸Ð¼Ð¸, ÑžÑˆÐ° Ð°ÑÐ» Ð¸Ð½ÑÐ¾Ð½Ð¸Ð¹ Ò›Ð°Ð´Ñ€Ð¸ÑÑ‚Ð»Ð°Ñ€Ð½Ð¸ ÑÐ°Ò›Ð»Ð°Ð± Ò›Ð¾Ð»Ð¸ÑˆÐ¸Ð½Ð³Ð¸Ð·Ð½Ð¸ Ñ‚Ð¸Ð»Ð°Ð¹Ð¼Ð°Ð½. "
    "ÒšÐ°Ñ€ÑˆÐ¸ Ð¾Ð»Ð¸Ð½Ð³Ð°Ð½ Ò³Ð°Ñ€ Ð±Ð¸Ñ€ ÑÐ½Ð³Ð¸ ÐºÑƒÐ½ ÑÐ¸Ð·Ð½Ð¸Ð½Ð³ ÑÐ½Ð³ ÑÑ…ÑˆÐ¸ ÐºÑƒÐ½Ð»Ð°Ñ€Ð¸Ð½Ð³Ð¸Ð·Ð´Ð°Ð½ Ð±ÑžÐ»ÑÐ¸Ð½!\n\n"
    "Ð¢ÑƒÒ“Ð¸Ð»Ð³Ð°Ð½ ÐºÑƒÐ½Ð¸Ð½Ð³Ð¸Ð· ÑÐ½Ð° Ð±Ð¸Ñ€ Ð±Ð¾Ñ€ Ð¼ÑƒÐ±Ð¾Ñ€Ð°Ðº Ð±ÑžÐ»ÑÐ¸Ð½! ðŸŽ‚âœ¨\n"
    "Ð¥ÑƒÑ€Ð¼Ð°Ñ‚ Ð±Ð¸Ð»Ð°Ð½ ÑÐ¸Ð½Ñ„Ð´Ð¾ÑˆÐ»Ð°Ñ€!!"
)

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð´Ð½Ð¸ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ
def check_birthdays():
    today = datetime.now().strftime("%-d %B").lower()
    for name, birthday in birthdays.items():
        if birthday.lower() == today:
            send_birthday_greeting(name)

def send_birthday_greeting(name):
    personalized_message = f"Ð¥ÑƒÑ€Ð¼Ð°Ñ‚Ð»Ð¸ {name},\n\n{BIRTHDAY_MESSAGE}"
    bot.send_message(chat_id="1946744681", text=personalized_message)

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹, Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ñ…ÑÑ Ñ *B
@bot.message_handler(func=lambda message: message.text.startswith("*B"))
def handle_gpt_query(message):
    user_input = message.text[2:].strip()  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑ *B
    response = get_gpt_response(user_input)
    bot.reply_to(message, response)

def get_gpt_response(query):
    try:
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",  # Ð˜Ð»Ð¸ "gpt-4", ÐµÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº GPT-4
            messages=[{"role": "user", "content": query}]
        )
        return response.choices[0].message['content'].strip()
    except Exception as e:
        return "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°."

if __name__ == "__main__":
    if len(sys.argv) > 1:
        if sys.argv[1] == "check_birthdays":
            check_birthdays()
    else:
        bot.polling()
